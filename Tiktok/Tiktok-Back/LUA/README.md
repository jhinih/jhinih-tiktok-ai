# TikTok 全链路压测方案

## 概述

本压测方案为 TikTok 后端项目提供完整的性能测试解决方案，包含多种业务场景的压测脚本，能够全面评估系统在不同负载下的性能表现。

## 压测场景

### 1. 全链路压测 (`full_chain_test.lua`)
**目标**: 模拟真实用户的完整业务流程
- **用户注册登录**: 30%
- **视频浏览**: 25% 
- **热点查询**: 20%
- **社交互动**: 25%

**特点**:
- 模拟100个测试用户池
- 1000个热点视频ID
- 真实的业务权重分布
- 完整的用户行为链路

### 2. 热点数据压测 (`hot_key_test.lua`)
**目标**: 测试缓存系统和热key处理能力
- **超级热点**: 1%数据承载80%流量
- **普通热点**: 9%数据承载15%流量
- **长尾数据**: 90%数据承载5%流量

**场景分布**:
- 热点读取: 70%
- 热点写入: 20%
- 冷数据访问: 10%

### 3. 写入密集型压测 (`write_intensive_test.lua`)
**目标**: 测试数据库写入性能和事务处理
- **视频创建**: 30%
- **点赞操作**: 25%
- **评论发布**: 20%
- **用户管理**: 15%
- **其他写入**: 10%

### 4. 混合场景压测 (`mixed_scenario_test.lua`)
**目标**: 模拟生产环境的复杂业务场景
- **用户分层**: 活跃用户(80%流量)、普通用户(15%)、潜水用户(5%)
- **时间权重**: 根据当前时间调整流量分布
- **业务场景**: 内容消费45%、社交互动25%、内容创作15%、用户管理10%、系统操作5%

### 5. 原有读取压测 (`read.lua`)
**目标**: 专注于热点视频读取性能
- 95%请求集中在1000个热门视频
- 模拟热key场景

## 快速开始

### 环境要求

1. **安装 wrk 工具**
```bash
# Ubuntu/Debian
sudo apt-get install wrk

# CentOS/RHEL
sudo yum install wrk

# macOS
brew install wrk

# 或从源码编译
git clone https://github.com/wg/wrk.git
cd wrk
make
sudo cp wrk /usr/local/bin/
```

2. **确保 TikTok 后端服务运行**
```bash
# 启动后端服务
cd /path/to/tiktok-backend
go run main.go
```

### 执行压测

1. **给执行脚本添加权限**
```bash
chmod +x LUA/run_tests.sh
```

2. **执行压测**
```bash
# 执行所有压测场景
./LUA/run_tests.sh all

# 执行特定场景
./LUA/run_tests.sh full-chain      # 全链路压测
./LUA/run_tests.sh hot-key         # 热点数据压测
./LUA/run_tests.sh write-intensive # 写入密集型压测
./LUA/run_tests.sh mixed-scenario  # 混合场景压测
./LUA/run_tests.sh stress          # 压力递增测试

# 生成测试报告
./LUA/run_tests.sh report

# 清理测试结果
./LUA/run_tests.sh clean
```

### 手动执行单个脚本

```bash
# 全链路压测 (12线程, 150连接, 120秒)
wrk -t12 -c150 -d120s -s LUA/full_chain_test.lua http://localhost:8080

# 热点数据压测 (15线程, 200连接, 90秒)
wrk -t15 -c200 -d90s -s LUA/hot_key_test.lua http://localhost:8080

# 写入密集型压测 (8线程, 80连接, 90秒)
wrk -t8 -c80 -d90s -s LUA/write_intensive_test.lua http://localhost:8080

# 混合场景压测 (10线程, 120连接, 180秒)
wrk -t10 -c120 -d180s -s LUA/mixed_scenario_test.lua http://localhost:8080
```

## 配置说明

### 基础配置
- **目标地址**: `http://localhost:8080` (可在脚本中修改)
- **默认持续时间**: 60-180秒 (根据场景不同)
- **线程数**: 8-20 (根据场景调整)
- **连接数**: 80-300 (根据场景调整)

### 自定义配置

可以通过修改各个 Lua 脚本中的配置参数来调整压测行为:

```lua
-- 在脚本开头修改配置
local config = {
    base_url = "http://your-server:port",
    user_count = 1000,        -- 用户池大小
    hot_video_count = 1000,   -- 热点视频数量
    -- 其他配置...
}
```

## 结果分析

### 关键指标

1. **QPS (每秒请求数)**
   - 衡量系统吞吐能力
   - 目标: >1000 QPS

2. **响应延迟**
   - 平均延迟: <100ms
   - 99%延迟: <500ms
   - 99.9%延迟: <1000ms

3. **成功率**
   - 目标: >99.9%
   - 监控4xx/5xx错误

4. **并发处理能力**
   - 最大并发连接数
   - 系统稳定性

### 性能基准

| 场景 | 目标QPS | 平均延迟 | 99%延迟 | 成功率 |
|------|---------|----------|---------|--------|
| 全链路 | 800+ | <80ms | <300ms | >99.5% |
| 热点读取 | 1500+ | <50ms | <200ms | >99.8% |
| 写入密集 | 300+ | <150ms | <500ms | >99.0% |
| 混合场景 | 600+ | <100ms | <400ms | >99.5% |

## 监控建议

### 系统监控
- CPU 使用率
- 内存使用率
- 磁盘 I/O
- 网络带宽

### 应用监控
- 数据库连接池
- 缓存命中率
- 接口响应时间
- 错误日志

### 数据库监控
- 慢查询
- 连接数
- 锁等待
- 事务处理时间

## 故障排查

### 常见问题

1. **连接被拒绝**
   - 检查服务是否启动
   - 确认端口是否正确
   - 检查防火墙设置

2. **响应延迟过高**
   - 检查数据库性能
   - 查看缓存命中率
   - 分析慢查询日志

3. **内存不足**
   - 调整JVM参数
   - 优化数据库配置
   - 检查内存泄漏

4. **数据库连接池耗尽**
   - 增加连接池大小
   - 优化SQL查询
   - 检查连接泄漏

## 最佳实践

### 压测前准备
1. 确保测试环境与生产环境配置相似
2. 准备充足的测试数据
3. 设置合适的监控和告警
4. 备份重要数据

### 压测执行
1. 从小负载开始，逐步增加
2. 监控系统资源使用情况
3. 记录详细的测试日志
4. 及时发现和处理异常

### 结果分析
1. 对比不同场景的性能表现
2. 识别性能瓶颈点
3. 制定优化方案
4. 验证优化效果

## 扩展开发

### 添加新的压测场景

1. 创建新的 Lua 脚本文件
2. 实现必要的函数:
   - `init()`: 初始化
   - `request()`: 生成请求
   - `response()`: 处理响应
   - `done()`: 结果统计

3. 在 `run_tests.sh` 中添加新的测试函数

### 自定义业务逻辑

可以根据具体业务需求修改脚本中的:
- 用户行为权重
- 数据分布模式
- 请求参数生成
- 响应处理逻辑

## 技术支持

如有问题或建议，请联系开发团队或提交 Issue。

---

**注意**: 请在测试环境中执行压测，避免对生产环境造成影响。